\section{Diagnostics--A Flexible Infrastructure}
\label{sec:pkg:diagnostics}
\begin{rawhtml}
<!-- CMIREDIR:package_diagnostics: -->
\end{rawhtml}

\subsection{Introduction}

\noindent
This section of the documentation describes the Diagnostics package available within 
the GCM.  A large selection of model diagnostics is available for output.  
In addition to the diagnostic quantities pre-defined in the GCM, there exists
the option, in any experiment, to define a new diagnostic quantity and include it
as part of the diagnostic output with the addition of a single subroutine call in the
routine where the field is computed. As a matter of philosophy, no diagnostic is enabled 
as default, thus each user must specify the exact diagnostic information required for an 
experiment.  This is accomplished by enabling the specific diagnostic of interest cataloged 
in the Diagnostic Menu (see Section \ref{sec:diagnostics:menu}). Instructions for enabling
diagnostic output and defining new diagnostic quantities are found in Section 
\ref{sec:diagnostics:usersguide} of this document.

\noindent
The Diagnostic Menu is a hard-wired enumeration of diagnostic quantities available within 
the GCM. Once a diagnostic is enabled, the GCM will continually increment an array
specifically allocated for that diagnostic whenever the appropriate quantity is computed.  
A counter is defined which records how many times each diagnostic quantity has been 
incremented.  Several special diagnostics are included in the menu. Quantities refered to 
as ``Counter Diagnostics'', are defined for selected diagnostics which record the 
frequency at which a diagnostic is incremented separately for each model grid location.
Quantitied refered to as ``User Diagnostics'' are included in the menu to facilitate
defining new diagnostics for a particular experiment.

\subsection{Equations}
Not relevant.

\subsection{Key Subroutines and Parameters}
\label{sec:diagnostics:diagover}

\noindent
The diagnostics are computed at various times and places within the GCM. Because the
MIT GCM may employ a staggered grid, diagnostics may be computed at grid box centers,
corners, or edges, and at the middle or edge in the vertical. Some diagnostics are scalars, 
while others are components of vectors. An internal array is defined which contains 
information concerning various grid attributes of each diagnostic. The GDIAG
array (in common block \\diagnostics in file diagnostics.h) is internally defined as a 
character*8 variable, and is equivalenced to a character*1 "parse" array in output in 
order to extract the grid-attribute information.  The GDIAG array is described in 
Table \ref{tab:diagnostics:gdiag.tabl}.

\begin{table}
\caption{Diagnostic Parsing Array}
\label{tab:diagnostics:gdiag.tabl}
\begin{center}
\begin{tabular}{ |c|c|l| }
\hline
\multicolumn{3}{|c|}{\bf Diagnostic Parsing Array} \\ 
\hline
\hline
Array & Value & Description \\
\hline
  parse(1)   & $\rightarrow$ S &  Scalar Diagnostic                 \\ 
             & $\rightarrow$ U &  U-vector component Diagnostic     \\ 
             & $\rightarrow$ V &  V-vector component Diagnostic     \\ \hline
  parse(2)   & $\rightarrow$ U &  C-Grid U-Point                    \\ 
             & $\rightarrow$ V &  C-Grid V-Point                    \\ 
             & $\rightarrow$ M &  C-Grid Mass Point                 \\ 
             & $\rightarrow$ Z &  C-Grid Vorticity (Corner) Point   \\ \hline
  parse(3)   & $\rightarrow$ R &  Not Currently in Use              \\ \hline
  parse(4)   & $\rightarrow$ P &  Positive Definite Diagnostic      \\ \hline
  parse(5)   & $\rightarrow$ C &  Counter Diagnostic                \\
             & $\rightarrow$ D &  Disabled Diagnostic for output    \\ \hline
  parse(6-8) & $\rightarrow$ C &  3-digit integer corresponding to  \\
             &                 &  vector or counter component mate  \\ \hline
\end{tabular}
\addcontentsline{lot}{section}{Table 3:  Diagnostic Parsing Array}
\end{center}
\end{table}


\noindent
As an example, consider a diagnostic whose associated GDIAG parameter is equal
to ``UU  002''.  From GDIAG we can determine that this diagnostic is a 
U-vector component located at the C-grid U-point.
Its corresponding V-component diagnostic is located in Diagnostic \# 002.


\noindent
In this way, each Diagnostic in the model has its attributes (ie. vector or scalar,
C-grid location, etc.) defined internally.  The Output routines use this information 
in order to determine what type of transformations need to be performed.  Any 
interpolations are done at the time of output rather than during each model step.
In this way the User has flexibility in determining the type of gridded data which 
is output.


\noindent
There are several utilities within the GCM available to users to enable, disable,
clear, write and retrieve model diagnostics, and may be called from any routine.  
The available utilities and the CALL sequences are listed below.


\noindent
{\bf fill\_diagnostics}:  This routine will increment the specified diagnostic
quantity with a field sent through the argument list.


\noindent
\begin{tabbing}
XXXXXXXXX\=XXXXXX\= \kill
\>        call fill\_diagnostics (myThid, chardiag, levflg, nlevs, \\
                bibjflg, bi, bj, arrayin) \\
\\
where \>  myThid   \>= Current Process(or) \\
      \>  chardiag \>= Character *8 expression for diag to fill \\
      \>  levflg   \>= Integer flag for vertical levels: \\
      \>           \> 0 indicates multiple levels incremented in qdiag \\
      \>           \> non-0 (any integer) - WHICH single level to increment. \\
      \>           \> negative integer - the input data array is single-leveled \\
      \>           \> positive integer - the input data array is multi-leveled \\
      \>  nlevs    \>= indicates Number of levels to be filled (1 if levflg <> 0) \\
      \>           \> positive: fill in "nlevs" levels in the same order as \\
      \>           \> the input array \\
      \>           \> negative: fill in -nlevs levels in reverse order. \\
      \>  bibjflg  \>= Integer flag to indicate instructions for bi bj loop \\
      \>           \> 0 indicates that the bi-bj loop must be done here \\
      \>           \> 1 indicates that the bi-bj loop is done OUTSIDE \\
      \>           \> 2 indicates that the bi-bj loop is done OUTSIDE \\
      \>           \>    AND that we have been sent a local array \\
      \>           \> 3 indicates that the bi-bj loop is done OUTSIDE \\
      \>           \>    AND that we have been sent a local array \\
      \>           \>    AND that the array has the shadow regions \\
      \>  bi       \>= X-direction process(or) number - used for bibjflg=1-3 \\
      \>  bj       \>= Y-direction process(or) number - used for bibjflg=1-3 \\
      \>  arrayin  \>= Field to increment diagnostics array \\
\end{tabbing}


\noindent
{\bf setdiag}:  This subroutine enables a diagnostic from the Diagnostic Menu, meaning 
that space is allocated for the diagnostic and the model routines will increment the 
diagnostic value during execution.  This routine is the underlying interface
between the user and the desired diagnostic.  The diagnostic is referenced by its diagnostic
number from the menu, and its calling sequence is given by:

\noindent
\begin{tabbing}
XXXXXXXXX\=XXXXXX\= \kill
\>        call setdiag (num) \\
\\
where \>  num   \>= Diagnostic number from menu \\
\end{tabbing}

\noindent
{\bf getdiag}:  This subroutine retrieves the value of a model diagnostic.  This routine 
is particulary useful when called from a user output routine, although it can be called 
from any routine.  This routine returns the time-averaged value of the diagnostic by
dividing the current accumulated diagnostic value by its corresponding counter.  This 
routine does not change the value of the diagnostic itself, that is, it does not replace 
the diagnostic with its time-average.  The calling sequence for this routine is givin by:

\noindent
\begin{tabbing}
XXXXXXXXX\=XXXXXX\= \kill
\>        call getdiag (lev,num,qtmp,undef) \\
\\
where \>  lev   \>= Model Level at which the diagnostic is desired \\
      \>  num   \>= Diagnostic number from menu \\
      \>  qtmp  \>= Time-Averaged Diagnostic Output \\
      \>  undef \>= Fill value to be used when diagnostic is undefined \\
\end{tabbing}

\noindent
{\bf clrdiag}:  This subroutine initializes the values of model diagnostics to zero, and is
particularly useful when called from user output routines to re-initialize diagnostics 
during the run.  The calling sequence is:

\noindent
\begin{tabbing}
XXXXXXXXX\=XXXXXX\= \kill
\>        call clrdiag (num) \\
\\
where \>  num   \>= Diagnostic number from menu \\
\end{tabbing}

\noindent
{\bf zapdiag}:  This entry into subroutine SETDIAG disables model diagnostics, meaning 
that the diagnostic is no longer available to the user.  The memory previously allocated 
to the diagnostic is released when ZAPDIAG is invoked.  The calling sequence is given by:

\noindent
\begin{tabbing}
XXXXXXXXX\=XXXXXX\= \kill
\>        call zapdiag (NUM) \\
\\
where \>  num   \>= Diagnostic number from menu \\
\end{tabbing}


\subsection{Usage Notes}
\label{sec:diagnostics:usersguide}

\noindent
We begin this section with a discussion on the manner in which computer 
memory is allocated for diagnostics. All GCM diagnostic quantities are stored in the 
single diagnostic array QDIAG which is located in the file \\
\filelink{pkg/diagnostics/diagnostics.h}{pkg-diagnostics-diagnostics.h}.
and has the form:

common /diagnostics/ qdiag(1-Olx,sNx+Olx,1-Olx,sNx+Olx,numdiags,Nsx,Nsy)

\noindent
where numdiags is an Integer variable which should be set equal to the number of 
enabled diagnostics, and qdiag is a three-dimensional array.  The first two-dimensions 
of qdiag correspond to the horizontal dimension of a given diagnostic, while the third 
dimension of qdiag is used to identify diagnostic fields and levels combined. In order 
to minimize the memory requirement of the model for diagnostics, the default GCM 
executable is compiled with room for only one horizontal diagnostic array, or with
numdiags set to 1. In order for the User to enable more than 1 two-dimensional diagnostic,
the size of the diagnostics common must be expanded to accomodate the desired diagnostics.
This can be accomplished by manually changing the parameter numdiags in the
file \filelink{pkg/diagnostics/diagnostics\_SIZE.h}{pkg-diagnostics-diagnostics_SIZE.h}.
numdiags should be set greater than or equal to the sum of all the diagnostics activated
for output each multiplied by the number of levels defined for that diagnostic quantity.
This is illustrated in the example below:

\noindent
To use the diagnostics package, other than enabling it in packages.conf
and turning the usediagnostics flag in data.pkg to .TRUE., a namelist
must be supplied in the run directory called data.diagnostics. The namelist
will activate a user-defined list of diagnostics quantities to be computed,
specify the frequency of output, the number of levels, and the name of
up to 10 separate output files. A sample data.diagnostics namelist file:

\noindent
$\#$ Diagnostic Package Choices \\
 $\&$diagnostics\_list \\
  frequency(1) = 10, \ \\
   levels(1,1) = 1.,2.,3.,4.,5., \ \\
   fields(1,1) = 'UVEL    ','VVEL    ', \ \\
   filename(1) = 'diagout1', \ \\
  frequency(2) = 100, \ \\
   levels(1,2) = 1.,2.,3.,4.,5., \ \\
   fields(1,2) = 'THETA   ','SALT    ', \ \\
   filename(2) = 'diagout2', \ \\
 $\&$end \ \\

\noindent
In this example, there are two output files that will be generated
for each tile and for each output time. The first set of output files
has the prefix diagout1, does time averaging every 10 time steps
(frequency is 10), they will write fields which are multiple-level 
fields and output levels 1-5. The names of diagnostics quantities are 
UVEL and VVEL.  The second set of output files
has the prefix diagout2, does time averaging every 100 time steps,
they include fields which are multiple-level fields, levels output are 1-5,
and the names of diagnostics quantities are THETA and SALT.

\noindent
In order to define and include as part of the diagnostic output any field
that is desired for a particular experiment, two steps must be taken. The
first is to enable the ``User Diagnostic'' in data.diagnostics. This is
accomplished by setting one of the fields slots to either UDIAG1 through 
UDIAG10, for multi-level fields, or SDIAG1 through SDIAG10 for single level
fields. These are listed in the diagnostics menu. The second step is to
add a call to fill\_diagnostics from the subroutine in which the quantity
desired for diagnostic output is computed. 

\newpage

\subsubsection{GCM Diagnostic Menu}
\label{sec:diagnostics:menu}

\begin{tabular}{lllll}
\hline\hline
N & NAME & UNITS & LEVELS & DESCRIPTION \\
\hline

&\\
84 & SDIAG1   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-1} 
         \end{minipage}\\
85 & SDIAG2   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-2} 
         \end{minipage}\\
86 & UDIAG1   &             &    Nrphys
         &\begin{minipage}[t]{3in}
          {User-Defined Upper-Air Diagnostic-1} 
         \end{minipage}\\
87 & UDIAG2   &             &    Nrphys
         &\begin{minipage}[t]{3in}
          {User-Defined Upper-Air Diagnostic-2} 
         \end{minipage}\\
124& SDIAG3   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-3} 
         \end{minipage}\\
125& SDIAG4   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-4} 
         \end{minipage}\\
126& SDIAG5   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-5} 
         \end{minipage}\\
127& SDIAG6   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-6} 
         \end{minipage}\\
128& SDIAG7   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-7} 
         \end{minipage}\\
129& SDIAG8   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-8} 
         \end{minipage}\\
130& SDIAG9   &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-9} 
         \end{minipage}\\
131& SDIAG10  &             &    1  
         &\begin{minipage}[t]{3in}
          {User-Defined Surface Diagnostic-1-} 
         \end{minipage}\\
132& UDIAG3   &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-3} 
         \end{minipage}\\
133& UDIAG4   &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-4} 
         \end{minipage}\\
134& UDIAG5   &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-5} 
         \end{minipage}\\
135& UDIAG6   &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-6} 
         \end{minipage}\\
136& UDIAG7   &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-7} 
         \end{minipage}\\
137& UDIAG8   &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-8} 
         \end{minipage}\\
138& UDIAG9   &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-9} 
         \end{minipage}\\
139& UDIAG10  &             &    Nrphys  
         &\begin{minipage}[t]{3in}
          {User-Defined Multi-Level Diagnostic-10} 
         \end{minipage}\\
\end{tabular}
\vspace{1.5in}
\vfill

\newpage
\vspace*{\fill}
\begin{tabular}{lllll}
\hline\hline
N & NAME & UNITS & LEVELS & DESCRIPTION \\
\hline

&\\
238& ETAN     & $(hPa,m)$ &    1
         &\begin{minipage}[t]{3in}
          {Perturbation of Surface (pressure, height)} 
         \end{minipage}\\
239& ETANSQ   & $(hPa^2,m^2)$ & 1
         &\begin{minipage}[t]{3in}
          {Square of Perturbation of Surface (pressure, height)} 
         \end{minipage}\\
240& THETA    & $deg K$ & Nr
         &\begin{minipage}[t]{3in}
          {Potential Temperature} 
         \end{minipage}\\
241& SALT     & $g/kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Salt (or Water Vapor Mixing Ratio)} 
         \end{minipage}\\
242& UVEL     & $m/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {U-Velocity} 
         \end{minipage}\\
243& VVEL     & $m/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {V-Velocity} 
         \end{minipage}\\
244& WVEL     & $m/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Vertical-Velocity} 
         \end{minipage}\\
245& THETASQ  & $deg^2$ & Nr
         &\begin{minipage}[t]{3in}
          {Square of Potential Temperature} 
         \end{minipage}\\
246& SALTSQ   & $g^2/{kg}^2$ & Nr
         &\begin{minipage}[t]{3in}
          {Square of Salt (or Water Vapor Mixing Ratio)} 
         \end{minipage}\\
247& UVELSQ   & $m^2/sec^2$ & Nr
         &\begin{minipage}[t]{3in}
          {Square of U-Velocity} 
         \end{minipage}\\
248& VVELSQ   & $m^2/sec^2$ & Nr
         &\begin{minipage}[t]{3in}
          {Square of V-Velocity} 
         \end{minipage}\\
249& WVELSQ   & $m^2/sec^2$ & Nr
         &\begin{minipage}[t]{3in}
          {Square of Vertical-Velocity} 
         \end{minipage}\\
250& UVELVVEL & $m^2/sec^2$ & Nr
         &\begin{minipage}[t]{3in}
          {Meridional Transport of Zonal Momentum} 
         \end{minipage}\\
251& UVELMASS & $m/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Zonal Mass-Weighted Component of Velocity} 
         \end{minipage}\\
252& VVELMASS & $m/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Meridional Mass-Weighted Component of Velocity} 
         \end{minipage}\\
253& WVELMASS & $m/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Vertical Mass-Weighted Component of Velocity} 
         \end{minipage}\\
254& UTHMASS  & $m-deg/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Zonal Mass-Weight Transp of Pot Temp} 
         \end{minipage}\\
255& VTHMASS  & $m-deg/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Meridional Mass-Weight Transp of Pot Temp} 
         \end{minipage}\\
256& WTHMASS  & $m-deg/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Vertical Mass-Weight Transp of Pot Temp} 
         \end{minipage}\\
257& USLTMASS & $m-kg/sec-kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Zonal Mass-Weight Transp of Salt (or W.Vap Mix Rat.)} 
         \end{minipage}\\
258& VSLTMASS & $m-kg/sec-kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Meridional Mass-Weight Transp of Salt (or W.Vap Mix Rat.)} 
         \end{minipage}\\
259& WSLTMASS & $m-kg/sec-kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Vertical Mass-Weight Transp of Salt (or W.Vap Mix Rat.)} 
         \end{minipage}\\
260& UVELTH   & $m-deg/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Zonal Transp of Pot Temp} 
         \end{minipage}\\
261& VVELTH   & $m-deg/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Meridional Transp of Pot Temp} 
         \end{minipage}\\
262& WVELTH   & $m-deg/sec$ & Nr
         &\begin{minipage}[t]{3in}
          {Vertical Transp of Pot Temp} 
         \end{minipage}\\
263& UVELSLT  & $m-kg/sec-kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Zonal Transp of Salt (or W.Vap Mix Rat.)} 
         \end{minipage}\\
264& VVELSLT  & $m-kg/sec-kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Meridional Transp of Salt (or W.Vap Mix Rat.)} 
         \end{minipage}\\
265& WVELSLT  & $m-kg/sec-kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Vertical Transp of Salt (or W.Vap Mix Rat.)} 
         \end{minipage}\\
275& WSLTMASS & $m-kg/sec-kg$ & Nr
         &\begin{minipage}[t]{3in}
          {Vertical Mass-Weight Transp of Salt (or W.Vap Mix Rat.)} 
         \end{minipage}\\
298& VISCA4   & $m^4/sec$ & 1
         &\begin{minipage}[t]{3in}
          {Biharmonic Viscosity Coefficient} 
         \end{minipage}\\
299& VISCAH   & $m^2/sec$ & 1
         &\begin{minipage}[t]{3in}
          {Harmonic Viscosity Coefficient} 
         \end{minipage}\\
300& DRHODR   & $kg/m^3/{r-unit}$ & Nr
         &\begin{minipage}[t]{3in}
          {Stratification: d.Sigma/dr} 
         \end{minipage}\\
301& DETADT2  & ${r-unit}^2/s^2$ & 1
         &\begin{minipage}[t]{3in}
          {Square of Eta (Surf.P,SSH) Tendency} 
         \end{minipage}\\
\end{tabular}
\vspace{1.5in}
\vfill

\newpage

\subsubsection{Diagnostic Description}

In this section we list and describe the diagnostic quantities available within the 
GCM.  The diagnostics are listed in the order that they appear in the 
Diagnostic Menu, Section \ref{sec:diagnostics:menu}.
In all cases, each diagnostic as currently archived on the output datasets
is time-averaged over its diagnostic output frequency:

\[
{\bf DIAGNOSTIC} = {1 \over TTOT} \sum_{t=1}^{t=TTOT} diag(t)
\]
where $TTOT = {{\bf NQDIAG} \over \Delta t}$, {\bf NQDIAG} is the 
output frequency of the diagnostic, and $\Delta t$ is
the timestep over which the diagnostic is updated.  

\subsection{Dos and Donts}

\subsection{Diagnostics Reference}

